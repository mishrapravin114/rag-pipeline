services:
  mysql:
    image: mysql:8.0
    container_name: mysql-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: fda_rag
      MYSQL_USER: fda_user
      MYSQL_PASSWORD: fda_password
    ports:
      - "3307:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
    command: --wait_timeout=3600 --interactive_timeout=3600 --max_allowed_packet=64M --innodb_lock_wait_timeout=300 --max_connections=200
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    networks:
      - fda-network

  qdrant:
    image: qdrant/qdrant:v1.11.5
    container_name: fda-qdrant-prod
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - /mnt/data/qdrant:/qdrant/storage
    environment:
      QDRANT__LOG_LEVEL: INFO
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - fda-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: fda-backend
    restart: always
    # Running as root for ChromaDB write permissions
    environment:
      # Database configuration with connection pool settings
      DATABASE_URL: "mysql+pymysql://fda_user:fda_password@mysql-db:3306/fda_rag?charset=utf8mb4"
      SQLALCHEMY_POOL_SIZE: 20
      SQLALCHEMY_POOL_TIMEOUT: 30
      SQLALCHEMY_POOL_RECYCLE: 3600
      SQLALCHEMY_MAX_OVERFLOW: 40
      SQLALCHEMY_POOL_PRE_PING: "true"
      
      # API Keys
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      SECRET_KEY: ${SECRET_KEY}
      
      # GCP Configuration for Pub/Sub
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      PUBSUB_TOPIC_ID: ${PUBSUB_TOPIC_ID}
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp_service_account_key
      GOOGLE_CLIENT_SECRETS_FILE: /run/secrets/google_client_secrets
      
      # Gunicorn configuration
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-4}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-1}
      GUNICORN_WORKER_CLASS: ${GUNICORN_WORKER_CLASS:-uvicorn.workers.UvicornWorker}
      GUNICORN_WORKER_CONNECTIONS: ${GUNICORN_WORKER_CONNECTIONS:-1000}
      GUNICORN_MAX_REQUESTS: ${GUNICORN_MAX_REQUESTS:-1000}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-900}
      
      # Application settings
      PYTHONUNBUFFERED: 1
      # Frontend URL for generating share links
      FRONTEND_URL: ${FRONTEND_URL:-https://dxdemo.rxinsightx.com}
      # Backend URL for OAuth callbacks
      BACKEND_URL: ${BACKEND_URL:-https://dxdemo.rxinsightx.com}
      LLM_GEMINI_MODEL: ${LLM_GEMINI_MODEL:-gemini-2.0-flash}
      MAX_TOKENS_PER_CHUNK: ${MAX_TOKENS_PER_CHUNK:-1000}
      OVERLAP_TOKENS: ${OVERLAP_TOKENS:-100}
      MAX_WORKERS: ${MAX_WORKERS:-10}
      BATCH_SIZE: ${BATCH_SIZE:-20}
      # Qdrant configuration
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_GRPC_PORT: 6334
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-WARNING}
      
      # CORS settings
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3001,http://34.9.3.61,https://dxdemo.rxinsightx.com,http://dxdemo.rxinsightx.com }
    ports:
      - "8090:8090"
    volumes:
      - ./backend/downloads:/app/downloads:rw
      - ./backend/uploads:/app/uploads:rw
      - ./backend/output:/app/output:rw
      - ./backend/scripts:/app/scripts:ro
      - ./backend/src:/app/src:ro
      - ./backend/data/chromadb:/app/data/chromadb:rw
      # Note: .env file is NOT mounted - all config via environment variables
    secrets:
      - gcp_service_account_key
      - google_client_secrets
    #depends_on:
    #  mysql:
    #    condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/api/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - fda-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # For production behind reverse proxy, use base URL without /api
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://dxdemo.rxinsightx.com }
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://dxdemo.rxinsightx.com }
        # Collection IDs for InsightXAI
        NEXT_PUBLIC_COLLECTION_ID_FDA: ${NEXT_PUBLIC_COLLECTION_ID_FDA:-1}
        NEXT_PUBLIC_COLLECTION_ID_EMA: ${NEXT_PUBLIC_COLLECTION_ID_EMA:-2}
        NEXT_PUBLIC_COLLECTION_ID_HTA_SWEDEN: ${NEXT_PUBLIC_COLLECTION_ID_HTA_SWEDEN:-3}
        NEXT_PUBLIC_COLLECTION_ID_HTA_FRANCE: ${NEXT_PUBLIC_COLLECTION_ID_HTA_FRANCE:-4}
        NEXT_PUBLIC_COLLECTION_ID_HTA_GERMANY: ${NEXT_PUBLIC_COLLECTION_ID_HTA_GERMANY:-5}
        NEXT_PUBLIC_GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    container_name: fda-frontend
    restart: always
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://dxdemo.rxinsightx.com }
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://dxdemo.rxinsightx.com }
      NODE_ENV: production
      # Collection IDs for InsightXAI
      NEXT_PUBLIC_COLLECTION_ID_FDA: ${NEXT_PUBLIC_COLLECTION_ID_FDA:-34}
      NEXT_PUBLIC_COLLECTION_ID_EMA: ${NEXT_PUBLIC_COLLECTION_ID_EMA:-35}
      NEXT_PUBLIC_COLLECTION_ID_HTA_SWEDEN: ${NEXT_PUBLIC_COLLECTION_ID_HTA_SWEDEN:-30}
      NEXT_PUBLIC_COLLECTION_ID_HTA_FRANCE: ${NEXT_PUBLIC_COLLECTION_ID_HTA_FRANCE:-36}
      NEXT_PUBLIC_COLLECTION_ID_HTA_GERMANY: ${NEXT_PUBLIC_COLLECTION_ID_HTA_GERMANY:-37}
      NEXT_PUBLIC_GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    ports:
      - "3001:3001"
    #depends_on:
    #  backend:
    #    condition: service_healthy
    networks:
      - fda-network

  vertex-ai-batch-processor:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: fda-vertex-ai-processor
    restart: always
    environment:
      # Database configuration
      DATABASE_URL: "mysql+pymysql://fda_user:fda_password@mysql-db:3306/fda_rag?charset=utf8mb4"
      # GCP Configuration - these will be read from the root .env file
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      GCP_REGION: ${GCP_REGION:-us-central1}
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      PUBSUB_TOPIC_ID: ${PUBSUB_TOPIC_ID}
      PUBSUB_SUBSCRIPTION_ID: ${PUBSUB_SUBSCRIPTION_ID:-batch-indexing-jobs-sub}
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp_service_account_key
      # Google API key for FDAPipelineV2
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      # Qdrant configuration
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_GRPC_PORT: 6334
    volumes:
      - ./backend/src:/app/src:ro
      - ./backend/scripts:/app/scripts:ro
      - ./backend/uploads:/app/uploads:rw
      - ./backend/output:/app/output:rw
      - ./backend/data/chromadb:/app/data/chromadb:rw
    secrets:
      - gcp_service_account_key
    #depends_on:
    #  mysql:
    #    condition: service_healthy
    networks:
      - fda-network
    command: >
      sh -c "
        echo 'Waiting for services to be ready...' &&
        sleep 20 &&
        python -m scripts.collection_indexer
      "

volumes:
  qdrant_data:

networks:
  fda-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

secrets:
  gcp_service_account_key:
    file: ./gcp-service-account-key.json
  google_client_secrets:
    file: ./google_client_secrets.json