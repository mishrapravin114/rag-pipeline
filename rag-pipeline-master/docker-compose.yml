version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: fda-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: fda_rag
      MYSQL_USER: fda_user
      MYSQL_PASSWORD: fda_password
    ports:
      - "3307:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
    command: --wait_timeout=3600 --interactive_timeout=3600 --max_allowed_packet=64M --innodb_lock_wait_timeout=300 --max_connections=200
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    networks:
      - fda-network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: fda-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    environment:
      QDRANT__LOG_LEVEL: INFO
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - fda-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fda-backend
    restart: unless-stopped
    environment:
      # Database configuration
      DATABASE_URL: "mysql+pymysql://fda_user:fda_password@mysql:3306/fda_rag"
      # Database connection pool settings (development values)
      SQLALCHEMY_POOL_SIZE: ${SQLALCHEMY_POOL_SIZE:-10}
      SQLALCHEMY_MAX_OVERFLOW: ${SQLALCHEMY_MAX_OVERFLOW:-20}
      SQLALCHEMY_POOL_TIMEOUT: ${SQLALCHEMY_POOL_TIMEOUT:-60}
      SQLALCHEMY_POOL_RECYCLE: ${SQLALCHEMY_POOL_RECYCLE:-3600}
      SQLALCHEMY_POOL_PRE_PING: ${SQLALCHEMY_POOL_PRE_PING:-true}
      SQLALCHEMY_ECHO_POOL: ${SQLALCHEMY_ECHO_POOL:-false}
      # API Keys and secrets from root .env file
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      PUBSUB_TOPIC_ID: ${PUBSUB_TOPIC_ID}
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-here}
      # Python settings
      PYTHONUNBUFFERED: 1
      # Frontend URL for generating share links
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3001}
      # Override settings.py defaults if needed
      LLM_GEMINI_MODEL: ${LLM_GEMINI_MODEL:-gemini-2.0-flash}
      MAX_TOKENS_PER_CHUNK: ${MAX_TOKENS_PER_CHUNK:-1000}
      OVERLAP_TOKENS: ${OVERLAP_TOKENS:-100}
      # PyMuPDF Processor settings
      CHUNK_SIZE: ${CHUNK_SIZE:-3000}
      CHUNK_OVERLAP: ${CHUNK_OVERLAP:-400}
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp_service_account_key
      GOOGLE_CLIENT_SECRETS_FILE: /run/secrets/google_client_secrets
    ports:
      - "8090:8090"
    volumes:
      - ./backend/downloads:/app/downloads
      - ./backend/uploads:/app/uploads
      - ./backend/output:/app/output
      - ./backend/src:/app/src
      - ./backend/main.py:/app/main.py
      - ./backend/migrations:/app/migrations
      - ./backend/data:/app/data
      # Remove .env volume mount - use environment variables instead
    secrets:
      - gcp_service_account_key
      - google_client_secrets
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - fda-network
    command: >
      sh -c "
        echo 'Waiting for MySQL to be ready...' &&
        sleep 10 &&
        python main.py
      "

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8090
        NEXT_PUBLIC_WS_URL: ws://localhost:8090
        NEXT_PUBLIC_GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    container_name: fda-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8090
      NEXT_PUBLIC_WS_URL: ws://localhost:8090
      NEXT_PUBLIC_GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    ports:
      - "3001:3001"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - fda-network

  vertex-ai-batch-processor:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fda-vertex-ai-processor
    restart: unless-stopped
    environment:
      # Database configuration
      DATABASE_URL: "mysql+pymysql://fda_user:fda_password@mysql:3306/fda_rag"
      # GCP Configuration - these will be read from the root .env file
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      GCP_REGION: ${GCP_REGION:-us-central1}
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      PUBSUB_TOPIC_ID: ${PUBSUB_TOPIC_ID}
      PUBSUB_SUBSCRIPTION_ID: ${PUBSUB_SUBSCRIPTION_ID:-batch-indexing-jobs-sub}
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp_service_account_key
      # Google API key for FDAPipelineV2
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    volumes:
      - ./backend/src:/app/src
      - ./backend/scripts:/app/scripts
      - ./backend/uploads:/app/uploads
    secrets:
      - gcp_service_account_key
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - fda-network
    command: >
      sh -c "
        echo 'Waiting for services to be ready...' &&
        sleep 20 &&
        python -m scripts.collection_indexer
      "

networks:
  fda-network:
    driver: bridge

volumes:
  mysql-data:

secrets:
  gcp_service_account_key:
    file: ./gcp_service_account_key.json
  google_client_secrets:
    file: ./google_client_secrets.json
